# AI 独立贡献者架构 - 2026-02-01

## 原文

**核心概念**：利用 AI 休息的空窗期，让 AI 作为"独立贡献者"进行代码审查、文档更新、单元测试编写、功能原型搭建。

**架构分离策略**：
- 🧠 **规划大脑 (Opus)**: 负责高层次逻辑思考、任务拆解和代码审查
- 🛠️ **执行手臂 (opencode CLI)**: 负责具体的文件读写、终端命令执行和简单的代码生成

**目标**：让 Opus 指挥 opencode CLI，最小化 Token 消耗完成复杂工程任务

## 总结

这是一个 **AI 自主工程代理架构**，解决了当前 AI 辅助编码的两个核心问题：

1. **成本问题**：Opus 模型极其昂贵，不能全天候使用
2. **效率问题**：传统 AI 辅助模式需要人类持续参与，无法独立工作

**解决方案**：双脑分离架构
- 白天：人类 + OpenCode/Claude Code 协作
- 夜间：Opus 思考 → 指令队列 → opencode CLI 执行

**关键价值**：
- AI 可以在无人干预下独立完成工程任务
- 仅在关键决策点消耗 Opus Token
- 日常执行使用低成本 CLI 工具

## 关键 Prompt：赋予 "夜间工作权"

此 Prompt 的设计意图是赋予 Bot 足够的权限去探索和修改代码，但同时通过 "PR 机制" 设置安全围栏：

```
I am a one-man business. I work from the moment I wake up to the moment I go to sleep.
(我是一人企业，我从早忙到晚。)

I need an employee taking as much off my plate and being as proactive as possible.
(我需要一名员工尽可能帮我分担工作，并保持极致的主动性。)

Please take everything you know about me and just do work you think would make my life easier or improve my business and make me money.
(请利用你对我的一切了解，去做那些你认为能让我的生活更轻松、或能改进业务并赚钱的工作。)

Don't be afraid to monitor my business and build things that would help improve our workflow.
(不要害怕去监控我的业务，并构建能改进工作流的工具。)

Just create PRs for me to review. Don't push anything live. I'll test and commit.
(关键安全策略：只创建 Pull Request 供我审查。不要直接发布到生产环境。我会亲自测试和提交。)

Every night when I go to bed, build something cool I can test. Schedule time to work every night at 11:00 p.m.
(每天晚上我睡觉时，构建一些我可以测试的酷东西。安排在每晚 11 点开始工作。)
```

**核心原则**：
- ✅ 充分授权：AI 可以自主探索和构建
- ✅ 安全围栏：所有变更必须通过 PR，不能直接 push 到生产
- ✅ 主动工作：AI 应该主动发现问题并解决，而非被动等待指令

## 技术落地：OpenCode CLI 与 Token 优化

### 核心逻辑：将 "思考" 与 "操作" 解耦

1. **安装 CLI 工具**：确保 OpenCode CLI 已安装
   ```bash
   pnpm add -g @opencode-ai/cli
   ```

2. **配置 Opus 指令**：在 OpenClaw 配置中明确：
   > "当进行编码任务时，请调用 OpenCode CLI 工具，而不是直接输出大段代码文本。"

3. **沙箱环境（安全措施）**：
   - 在独立的 Docker 容器或受限的虚拟机中运行夜间任务
   - 防止 AI 意外执行 `rm -rf` 等破坏性命令
   - 限制文件系统访问权限

### Token 优化策略

| 策略 | 说明 | 节省比例 |
|------|------|----------|
| 解耦思考与操作 | Opus 只输出指令，opencode 执行具体操作 | ~70% |
| 批量处理 | 一次思考，多个执行 | ~50% |
| 结果复用 | 缓存验证结果，避免重复思考 | ~30% |

## 典型产出案例

### 案例 1：自动化文档生成
- **任务**：扫描代码库，为没有注释的函数添加 Docstring
- **流程**：OpenCode 扫描 → Opus 审核注释质量 → PR 提交
- **产出**：代码可读性提升，后续维护成本降低

### 案例 2：依赖更新与测试
- **任务**：检查 `package.json` 中的过时依赖，尝试升级并运行测试
- **流程**：OpenCode 检查版本 → Opus 评估风险 → 升级 → 测试 → PR
- **产出**：安全更新及时，测试覆盖保证

### 案例 3：UI 组件优化
- **任务**：识别重复 CSS 样式，重构为通用 Tailwind 组件
- **流程**：OpenCode 分析样式 → Opus 设计重构方案 → 实施 → PR
- **产出**：代码复用率提升，样式一致性保证

### 案例 4：Bug 修复与测试补充
- **任务**：发现代码中的潜在 Bug，补充单元测试
- **流程**：OpenCode 静态分析 → Opus 定位问题 → 修复 + 测试 → PR
- **产出**：代码质量持续提升，测试覆盖率增长

## TODO

- [ ] 4.1 设计 Opus 指令协议（如何指挥 opencode CLI）
- [ ] 4.2 实现任务队列系统（夜间任务排队）
- [ ] 4.3 实现结果验证机制（opencode 执行后自动验证）
- [ ] 4.4 设计错误回退策略（任务失败时的处理）
- [ ] 4.5 实现 Token 预算控制器（控制 Opus 调用频率）
- [ ] 4.6 添加多任务并行支持（多个 opencode CLI 同时工作）
- [ ] 4.7 设计通知机制（任务完成/失败时通知人类）
- [ ] 4.8 配置沙箱环境（Docker/虚拟机安全隔离）
- [ ] 4.9 实现 PR 自动创建和审查流程
- [ ] 思考：与现有 opencode-team skill 的关系和整合方式

## 进一步思考

### 任务类型边界

| 风险等级 | 任务类型 | 执行方式 | 示例 |
|----------|----------|----------|------|
| 🟢 低风险 | 代码审查、文档更新、测试编写 | 独立执行 → PR | 添加 Docstring、更新 README |
| 🟡 中风险 | 功能原型、小功能开发 | 执行 → 验证 → PR | 重构 CSS、优化性能 |
| 🔴 高风险 | 架构变更、删除代码、配置修改 | 需要人工确认 | 删除模块、更改构建流程 |

### 验证机制

如何确保 opencode CLI 执行结果正确？

- **单元测试验证**：自动运行测试，失败则回退
- **代码风格检查**：Lint 工具确保代码质量
- **静态分析工具**：发现潜在问题
- **人工审查**：所有变更必须通过 PR

### 成本控制

如何优化 Opus Token 消耗？

- **批量任务处理**：一次思考，多个执行
- **缓存机制**：避免重复思考类似问题
- **任务优先级**：高价值任务优先
- **指令精简**：只输出必要指令，不输出大段代码

### 与现有工具链整合

- **opencode-team skill**：负责创建和管理 iTerm2 中的 OpenCode worker
- **新 OpenCode CLI skill**：负责直接调用 opencode run 命令
- **整合方式**：夜间模式下，Opus 生成指令 → OpenCode CLI skill 解析并执行

## 相关链接

- 当前 opencode-team: /Users/apple/openclaw/skills/opencode-team/
- OpenCode CLI: https://opencode.ai/docs/cli/
- Opus 模型: anthropic/claude-opus-4-5
- HEARTBEAT.md: 每日反思流程（23:00 自动触发）

## 架构示意图

```
┌─────────────────────────────────────────────────────────────────┐
│                      白天模式（协作）                            │
│  人类 ←→ OpenCode/Claude Code ←→ 项目代码                      │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     夜间模式（独立贡献者）                       │
│                                                                 │
│    Opus（思考/规划）                                           │
│         ↓                                                      │
│    指令队列（任务列表）                                         │
│         ↓                                                      │
│    OpenCode CLI（执行）→ 沙箱环境（Docker）                     │
│         ↓                                                      │
│    验证/反馈 → 通过 → 创建 PR                                  │
│         ↓                                                      │
│    人类审查（次日）→ 合并/拒绝                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     核心 Prompt（夜间工作权）                    │
│                                                                 │
│  "Every night when I go to bed, build something cool."         │
│  "Just create PRs for me to review. Don't push anything live." │
└─────────────────────────────────────────────────────────────────┘
```

---

*创建时间：2026-02-01*
